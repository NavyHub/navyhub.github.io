<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> Kubernete概念解析之Deployment - jimmysong.io|宋净超的博客|Cloud Native Developer Advocate</title>
  <meta name="description" content="jimmysong.io|宋净超的博客|Cloud Native Developer Advocate" />
  <meta property="og:title" content="Kubernete概念解析之Deployment" />
  <meta name="twitter:title" content="Kubernete概念解析之Deployment" />
  <meta name="description" content="前言 本文同步更新到Github仓库kubernetes-handbook中。 本文翻译自kubernetes官方文档 - Deployement 本文章根据2017年5">
  <meta property="og:description" content="前言 本文同步更新到Github仓库kubernetes-handbook中。 本文翻译自kubernetes官方文档 - Deployement 本文章根据2017年5">
  <meta name="twitter:description" content="前言 本文同步更新到Github仓库kubernetes-handbook中。 本文翻译自kubernetes官方文档 - Deployement 本文章根据2017年5">
  <meta name="author" content="Jimmy Song(宋净超)"/>
  <link href='https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" />
  <meta name="twitter:image" content="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jimmysongio" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/posts/kubernetes-concept-deployment/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Jimmy Song" />

  <meta name="generator" content="Hugo 0.40" />
  <link rel="canonical" href="https://jimmysong.io/posts/kubernetes-concept-deployment/" />
  <link rel="alternate" href="https://jimmysong.io/index.xml" type="application/rss+xml" title="Jimmy Song">
  <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://jimmysong.io/css/main.css" />
  <link rel="stylesheet" href="https://jimmysong.io/css/search.css" />
  
  

<meta name="baidu-site-verification" content="g8IYR9SNLF" />
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>

<link rel="stylesheet" href="https://jimmysong.io/css/prism.css" />




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://jimmysong.io/">Jimmy Song</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Categories</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/categories/kubernetes">kubernetes</a>
                
                
                  <a href="https://jimmysong.io/categories/cloud-native">Cloud Native</a>
                
                
                  <a href="https://jimmysong.io/categories/microservices">Microservices</a>
                
                
                  <a href="https://jimmysong.io/categories/devops">Devops</a>
                
                
                  <a href="https://jimmysong.io/categories/github">Github</a>
                
                
                  <a href="https://jimmysong.io/categories/serverless">Serverless</a>
                
                
                  <a href="https://jimmysong.io/categories/service-mesh">Service Mesh</a>
                
                
                  <a href="https://jimmysong.io/tags">Tags</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Gitbooks</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes handbook</a>
                
                
                  <a href="https://jimmysong.io/docker-handbook">Docker handbook</a>
                
                
                  <a href="https://jimmysong.io/hugo-handbook">Hugo Handbook</a>
                
                
                  <a href="https://servicemesher.github.io/envoy">Envoy proxy中文文档</a>
                
                
                  <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Publications</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a>
                
                
                  <a href="https://jimmysong.io/posts/cloud-native-python">Cloud Native Python</a>
                
                
                  <a href="https://jimmysong.io/posts/cloud-native-java">Cloud Native Java</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
              <div class="navlinks-children">
                
                
                  <a href="https://github.com/rootsongjc/kubernetes-vagrant-centos-cluster">k8s all-in-one</a>
                
                
                  <a href="https://jimmysong.io/spark-on-k8s">Spark on kubernetes</a>
                
                
                  <a href="https://jimmysong.io/posts/yarn-on-docker">Magpie</a>
                
                
                  <a href="https://jimmysong.io/cheatsheets">Cheatsheets</a>
                
                
                  <a href="https://github.com/rootsongjc/beautifulhugo">Beautifulhugo</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
              
              
            </li>
          
        

        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Jimmy Song" href="https://jimmysong.io/">
            <img class="avatar-img" src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" alt="Jimmy Song" />
          </a>
        
      </div>
    </div>

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search jimmysong.io</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>



<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>

<script>
var client = algoliasearch("X4YB3WOBNV", "d2134c5a8d250e6d3246594240c45201");
var index = client.initIndex('rootsongjc-hugo');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            
            return '<span>' + '<a href="/' + suggestion.uri+ '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://res.cloudinary.com/jimmysong/image/upload/images/20170430008.jpg" data-img-desc-1="京广桥@北京国贸 Apr 30,2017"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        
        <div class="container">
          <div class="row">
              <div class="col-lg-12 col-md-12 col-md-offset-0">
                
                <div class="post-heading">
                
                  
                     <h1>Kubernete概念解析之Deployment</h1>
                     
                    <span class="post-meta">
  
  Posted on May 13, 2017
  
  
</span>


                    
                  
                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">Kubernete概念解析之Deployment</h1>
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main" itemscope itemtype="http://schema.org/Article">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            
            
<div>
    <section id="datecount">
        <h4 id="date"> Sat May 13, 2017</h4>
    </section>
    <h5 id="wc">12500 Words|Read in about 25 Min</h5>
    <h5 id="tags">Tags: 
        
        <a href="https://jimmysong.io/tags/kubernetes/">kubernetes</a> &nbsp;
    </h5>
</div>

            
            <article role="main" class="blog-post" itemprop="articleBody" id="content">
                
  
  <aside class="toc">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#deployment是什么">Deployment是什么？</a></li>
<li><a href="#创建deployment">创建Deployment</a></li>
<li><a href="#更新deployment">更新Deployment</a>
<ul>
<li><a href="#rollover-多个rollout并行">Rollover（多个rollout并行）</a></li>
</ul></li>
<li><a href="#回退deployment">回退Deployment</a>
<ul>
<li><a href="#检查deployment升级的历史记录">检查Deployment升级的历史记录</a></li>
<li><a href="#回退到历史版本">回退到历史版本</a></li>
<li><a href="#清理policy">清理Policy</a></li>
</ul></li>
<li><a href="#deployment扩容">Deployment扩容</a></li>
<li><a href="#比例扩容">比例扩容</a></li>
<li><a href="#暂停和恢复deployment">暂停和恢复Deployment</a></li>
<li><a href="#deployment状态">Deployment状态</a>
<ul>
<li><a href="#progressing-deployment">Progressing Deployment</a></li>
<li><a href="#complete-deployment">Complete Deployment</a></li>
<li><a href="#failed-deployment">Failed Deployment</a></li>
<li><a href="#操作失败的deployment">操作失败的Deployment</a></li>
</ul></li>
<li><a href="#清理policy-1">清理Policy</a></li>
<li><a href="#用例">用例</a>
<ul>
<li><a href="#金丝雀deployment">金丝雀Deployment</a></li>
</ul></li>
<li><a href="#编写deployment-spec">编写Deployment Spec</a>
<ul>
<li><a href="#pod-template">Pod Template</a></li>
<li><a href="#replicas">Replicas</a></li>
<li><a href="#selector">Selector</a></li>
<li><a href="#策略">策略</a>
<ul>
<li><a href="#recreate-deployment">Recreate Deployment</a></li>
<li><a href="#rolling-update-deployment">Rolling Update Deployment</a>
<ul>
<li><a href="#max-unavailable">Max Unavailable</a></li>
<li><a href="#max-surge">Max Surge</a></li>
</ul></li>
</ul></li>
<li><a href="#progress-deadline-seconds">Progress Deadline Seconds</a></li>
<li><a href="#min-ready-seconds">Min Ready Seconds</a></li>
<li><a href="#rollback-to">Rollback To</a>
<ul>
<li><a href="#revision">Revision</a></li>
</ul></li>
<li><a href="#revision-history-limit">Revision History Limit</a></li>
<li><a href="#paused">Paused</a></li>
</ul></li>
<li><a href="#alternative-to-deployments">Alternative to Deployments</a>
<ul>
<li><a href="#kubectl-rolling-update">kubectl rolling update</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </aside>
  


                

<h2 id="前言">前言</h2>

<p>本文同步更新到Github仓库<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>中。</p>

<p><a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md">本文翻译自kubernetes官方文档 - Deployement </a></p>

<p>本文章根据2017年5月10日的<code>Commit 8481c02</code>翻译。</p>

<p>Deployment是Kubernetes中的一个非常重要的概念，从它开始是了解kubernetes中资源概念的一个很好的切入点，看到网上也没什么详细的说明文档，我就随手翻译了一下官方文档（Github中的文档），kubernetes官网上的文档还没有这个新。这篇文章对Deployment的概念解释的面面俱到十分详尽。</p>

<h2 id="deployment是什么">Deployment是什么？</h2>

<p>Deployment为Pod和Replica Set（下一代Replication Controller）提供声明式更新。</p>

<p>你只需要在Deployment中描述你想要的目标状态是什么，Deployment controller就会帮你将Pod和Replica Set的实际状态改变到你的目标状态。你可以定义一个全新的Deployment，也可以创建一个新的替换旧的Deployment。</p>

<p>一个典型的用例如下：</p>

<ul>
<li>使用Deployment来创建ReplicaSet。ReplicaSet在后台创建pod。检查启动状态，看它是成功还是失败。</li>
<li>然后，通过更新Deployment的PodTemplateSpec字段来声明Pod的新状态。这会创建一个新的ReplicaSet，Deployment会按照控制的速率将pod从旧的ReplicaSet移动到新的ReplicaSet中。</li>
<li>如果当前状态不稳定，回滚到之前的Deployment revision。每次回滚都会更新Deployment的revision。</li>
<li>扩容Deployment以满足更高的负载。</li>
<li>暂停Deployment来应用PodTemplateSpec的多个修复，然后恢复上线。</li>
<li>根据Deployment 的状态判断上线是否hang住了。</li>
<li>清除旧的不必要的ReplicaSet。</li>
</ul>

<h2 id="创建deployment">创建Deployment</h2>

<p>下面是一个Deployment示例，它创建了一个Replica Set来启动3个nginx pod。</p>

<p>下载示例文件并执行命令：</p>

<pre><code class="language-shell">$ kubectl create -f docs/user-guide/nginx-deployment.yaml --record
deployment &quot;nginx-deployment&quot; created
</code></pre>

<p>将kubectl的 <code>—record</code> 的flag设置为 <code>true</code>可以在annotation中记录当前命令创建或者升级了该资源。这在未来会很有用，例如，查看在每个Deployment revision中执行了哪些命令。</p>

<p>然后立即执行<code>get</code>í将获得如下结果：</p>

<pre><code class="language-shell">$ kubectl get deployments
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3         0         0            0           1s
</code></pre>

<p>输出结果表明我们希望的repalica数是3（根据deployment中的<code>.spec.replicas</code>配置）当前replica数（ <code>.status.replicas</code>）是0, 最新的replica数（<code>.status.updatedReplicas</code>）是0，可用的replica数（<code>.status.availableReplicas</code>）是0。</p>

<p>过几秒后再执行<code>get</code>命令，将获得如下输出：</p>

<pre><code class="language-shell">$ kubectl get deployments
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3         3         3            3           18s
</code></pre>

<p>我们可以看到Deployment已经创建了3个replica，所有的replica都已经是最新的了（包含最新的pod template），可用的（根据Deployment中的<code>.spec.minReadySeconds</code>声明，处于已就绪状态的pod的最少个数）。执行<code>kubectl get rs</code>和<code>kubectl get pods</code>会显示Replica Set（RS）和Pod已创建。</p>

<pre><code class="language-shell">$ kubectl get rs
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-2035384211   3         3         0       18s
</code></pre>

<p>你可能会注意到Replica Set的名字总是<code>&lt;Deployment的名字&gt;-&lt;pod template的hash值&gt;</code>。</p>

<pre><code class="language-shell">$ kubectl get pods --show-labels
NAME                                READY     STATUS    RESTARTS   AGE       LABELS
nginx-deployment-2035384211-7ci7o   1/1       Running   0          18s       app=nginx,pod-template-hash=2035384211
nginx-deployment-2035384211-kzszj   1/1       Running   0          18s       app=nginx,pod-template-hash=2035384211
nginx-deployment-2035384211-qqcnn   1/1       Running   0          18s       app=nginx,pod-template-hash=2035384211
</code></pre>

<p>刚创建的Replica Set将保证总是有3个nginx的pod存在。</p>

<p><strong>注意：</strong> 你必须在Deployment中的selector指定正确pod template label（在该示例中是 <code>app = nginx</code>），不要跟其他的controller搞混了（包括Deployment、Replica Set、Replication Controller等）。<strong>Kubernetes本身不会阻止你这么做</strong>，如果你真的这么做了，这些controller之间会相互打架，并可能导致不正确的行为。</p>

<h2 id="更新deployment">更新Deployment</h2>

<p><strong>注意：</strong> Deployment的rollout当且仅当Deployment的pod template（例如<code>.spec.template</code>）中的label更新或者镜像更改时被触发。其他更新，例如扩容Deployment不会触发rollout。</p>

<p>假如我们现在想要让nginx pod使用<code>nginx:1.9.1</code>的镜像来代替原来的<code>nginx:1.7.9</code>的镜像。</p>

<pre><code class="language-shell">$ kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1
deployment &quot;nginx-deployment&quot; image updated
</code></pre>

<p>我们可以使用<code>edit</code>命令来编辑Deployment，修改 <code>.spec.template.spec.containers[0].image</code> ，将<code>nginx:1.7.9</code> 改写成 <code>nginx:1.9.1</code>。</p>

<pre><code class="language-shell">$ kubectl edit deployment/nginx-deployment
deployment &quot;nginx-deployment&quot; edited
</code></pre>

<p>查看rollout的状态，只要执行：</p>

<pre><code class="language-shell">$ kubectl rollout status deployment/nginx-deployment
Waiting for rollout to finish: 2 out of 3 new replicas have been updated...
deployment &quot;nginx-deployment&quot; successfully rolled out
</code></pre>

<p>Rollout成功后，<code>get</code> Deployment：</p>

<pre><code class="language-shell">$ kubectl get deployments
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3         3         3            3           36s
</code></pre>

<p>UP-TO-DATE的replica的数目已经达到了配置中要求的数目。</p>

<p>CURRENT的replica数表示Deployment管理的replica数量，AVAILABLE的replica数是当前可用的replica数量。</p>

<p>We can run <code>kubectl get rs</code> to see that the Deployment updated the Pods by creating a new Replica Set and scaling it up to 3 replicas, as well as scaling down the old Replica Set to 0 replicas.</p>

<p>我们通过执行<code>kubectl get rs</code>可以看到Deployment更新了Pod，通过创建一个新的Replica Set并扩容了3个replica，同时将原来的Replica Set缩容到了0个replica。</p>

<pre><code class="language-shell">$ kubectl get rs
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-1564180365   3         3         0       6s
nginx-deployment-2035384211   0         0         0       36s
</code></pre>

<p>执行 <code>get pods</code>只会看到当前的新的pod:</p>

<pre><code class="language-shell">$ kubectl get pods
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-1564180365-khku8   1/1       Running   0          14s
nginx-deployment-1564180365-nacti   1/1       Running   0          14s
nginx-deployment-1564180365-z9gth   1/1       Running   0          14s
</code></pre>

<p>下次更新这些pod的时候，只需要更新Deployment中的pod的template即可。</p>

<p>Deployment可以保证在升级时只有一定数量的Pod是down的。默认的，它会确保至少有比期望的Pod数量少一个的Pod是up状态（最多一个不可用）。</p>

<p>Deployment同时也可以确保只创建出超过期望数量的一定数量的Pod。默认的，它会确保最多比期望的Pod数量多一个的Pod是up的（最多1个surge）。</p>

<p><strong>在未来的Kuberentes版本中，将从1-1变成25%-25%）。</strong></p>

<p>例如，如果你自己看下上面的Deployment，你会发现，开始创建一个新的Pod，然后删除一些旧的Pod再创建一个新的。当新的Pod创建出来之前不会杀掉旧的Pod。这样能够确保可用的Pod数量至少有2个，Pod的总数最多4个。</p>

<pre><code class="language-shell">$ kubectl describe deployments
Name:           nginx-deployment
Namespace:      default
CreationTimestamp:  Tue, 15 Mar 2016 12:01:06 -0700
Labels:         app=nginx
Selector:       app=nginx
Replicas:       3 updated | 3 total | 3 available | 0 unavailable
StrategyType:       RollingUpdate
MinReadySeconds:    0
RollingUpdateStrategy:  1 max unavailable, 1 max surge
OldReplicaSets:     &lt;none&gt;
NewReplicaSet:      nginx-deployment-1564180365 (3/3 replicas created)
Events:
  FirstSeen LastSeen    Count   From                     SubobjectPath   Type        Reason              Message
  --------- --------    -----   ----                     -------------   --------    ------              -------
  36s       36s         1       {deployment-controller }                 Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-2035384211 to 3
  23s       23s         1       {deployment-controller }                 Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 1
  23s       23s         1       {deployment-controller }                 Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 2
  23s       23s         1       {deployment-controller }                 Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 2
  21s       21s         1       {deployment-controller }                 Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 0
  21s       21s         1       {deployment-controller }                 Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 3
</code></pre>

<p>我们可以看到当我们刚开始创建这个Deployment的时候，创建了一个Replica Set（nginx-deployment-2035384211），并直接扩容到了3个replica。</p>

<p>当我们更新这个Deployment的时候，它会创建一个新的Replica Set（nginx-deployment-1564180365），将它扩容到1个replica，然后缩容原先的Replica Set到2个replica，此时满足至少2个Pod是可用状态，同一时刻最多有4个Pod处于创建的状态。</p>

<p>接着继续使用相同的rolling update策略扩容新的Replica Set和缩容旧的Replica Set。最终，将会在新的Replica Set中有3个可用的replica，旧的Replica Set的replica数目变成0。</p>

<h3 id="rollover-多个rollout并行">Rollover（多个rollout并行）</h3>

<p>每当Deployment controller观测到有新的deployment被创建时，如果没有已存在的Replica Set来创建期望个数的Pod的话，就会创建出一个新的Replica Set来做这件事。已存在的Replica Set控制label匹配<code>.spec.selector</code>但是template跟<code>.spec.template</code>不匹配的Pod缩容。最终，新的Replica Set将会扩容出<code>.spec.replicas</code>指定数目的Pod，旧的Replica Set会缩容到0。</p>

<p>如果你更新了一个的已存在并正在进行中的Deployment，每次更新Deployment都会创建一个新的Replica Set并扩容它，同时回滚之前扩容的Replica Set——将它添加到旧的Replica Set列表，开始缩容。</p>

<p>例如，假如你创建了一个有5个<code>niginx:1.7.9</code> replica的Deployment，但是当还只有3个<code>nginx:1.7.9</code>的replica创建出来的时候你就开始更新含有5个<code>nginx:1.9.1</code> replica的Deployment。在这种情况下，Deployment会立即杀掉已创建的3个<code>nginx:1.7.9</code>的Pod，并开始创建<code>nginx:1.9.1</code>的Pod。它不会等到所有的5个<code>nginx:1.7.9</code>的Pod都创建完成后才开始改变航道。</p>

<h2 id="回退deployment">回退Deployment</h2>

<p>有时候你可能想回退一个Deployment，例如，当Deployment不稳定时，比如一直crash looping。</p>

<p>默认情况下，kubernetes会在系统中保存前两次的Deployment的rollout历史记录，以便你可以随时会退（你可以修改<code>revision history limit</code>来更改保存的revision数）。ß</p>

<p><strong>注意：</strong>只要Deployment的rollout被触发就会创建一个revision。也就是说当且仅当Deployment的Pod template（如<code>.spec.template</code>）被更改，例如更新template中的label和容器镜像时，就会创建出一个新的revision。</p>

<p>其他的更新，比如扩容Deployment不会创建revision——因此我们可以很方便的手动或者自动扩容。这意味着当你回退到历史revision是，直邮Deployment中的Pod template部分才会回退。</p>

<p>假设我们在更新Deployment的时候犯了一个拼写错误，将镜像的名字写成了<code>nginx:1.91</code>，而正确的名字应该是<code>nginx:1.9.1</code>：</p>

<pre><code class="language-shell">$ kubectl set image deployment/nginx-deployment nginx=nginx:1.91
deployment &quot;nginx-deployment&quot; image updated
</code></pre>

<p>Rollout将会卡住。</p>

<pre><code class="language-shell">$ kubectl rollout status deployments nginx-deployment
Waiting for rollout to finish: 2 out of 3 new replicas have been updated...
</code></pre>

<p>按住Ctrl-C停止上面的rollout状态监控。</p>

<p>你会看到旧的replicas（nginx-deployment-1564180365 和 nginx-deployment-2035384211）和新的replicas （nginx-deployment-3066724191）数目都是2个。</p>

<pre><code class="language-shell">$ kubectl get rs
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-1564180365   2         2         0       25s
nginx-deployment-2035384211   0         0         0       36s
nginx-deployment-3066724191   2         2         2       6s
</code></pre>

<p>看下创建Pod，你会看到有两个新的呃Replica Set创建的Pod处于ImagePullBackOff状态，循环拉取镜像。</p>

<pre><code class="language-shell">$ kubectl get pods
NAME                                READY     STATUS             RESTARTS   AGE
nginx-deployment-1564180365-70iae   1/1       Running            0          25s
nginx-deployment-1564180365-jbqqo   1/1       Running            0          25s
nginx-deployment-3066724191-08mng   0/1       ImagePullBackOff   0          6s
nginx-deployment-3066724191-eocby   0/1       ImagePullBackOff   0          6s
</code></pre>

<p>注意，Deployment controller会自动停止坏的rollout，并停止扩容新的Replica Set。</p>

<pre><code class="language-shell">$ kubectl describe deployment
Name:           nginx-deployment
Namespace:      default
CreationTimestamp:  Tue, 15 Mar 2016 14:48:04 -0700
Labels:         app=nginx
Selector:       app=nginx
Replicas:       2 updated | 3 total | 2 available | 2 unavailable
StrategyType:       RollingUpdate
MinReadySeconds:    0
RollingUpdateStrategy:  1 max unavailable, 1 max surge
OldReplicaSets:     nginx-deployment-1564180365 (2/2 replicas created)
NewReplicaSet:      nginx-deployment-3066724191 (2/2 replicas created)
Events:
  FirstSeen LastSeen    Count   From                    SubobjectPath   Type        Reason              Message
  --------- --------    -----   ----                    -------------   --------    ------              -------
  1m        1m          1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-2035384211 to 3
  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 1
  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 2
  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 2
  21s       21s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 0
  21s       21s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 3
  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 1
  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-1564180365 to 2
  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 2
</code></pre>

<p>为了修复这个问题，我们需要回退到稳定的Deployment revision。</p>

<h3 id="检查deployment升级的历史记录">检查Deployment升级的历史记录</h3>

<p>首先，检查下Deployment的revision：</p>

<pre><code class="language-shell">$ kubectl rollout history deployment/nginx-deployment
deployments &quot;nginx-deployment&quot;:
REVISION    CHANGE-CAUSE
1           kubectl create -f docs/user-guide/nginx-deployment.yaml --record
2           kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1
3           kubectl set image deployment/nginx-deployment nginx=nginx:1.91
</code></pre>

<p>因为我们创建Deployment的时候使用了<code>—recored</code>参数可以记录命令，我们可以很方便的查看每次revison的变化。</p>

<p>查看单个revision的详细信息：</p>

<pre><code class="language-shell">$ kubectl rollout history deployment/nginx-deployment --revision=2
deployments &quot;nginx-deployment&quot; revision 2
  Labels:       app=nginx
          pod-template-hash=1159050644
  Annotations:  kubernetes.io/change-cause=kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1
  Containers:
   nginx:
    Image:      nginx:1.9.1
    Port:       80/TCP
     QoS Tier:
        cpu:      BestEffort
        memory:   BestEffort
    Environment Variables:      &lt;none&gt;
  No volumes.
</code></pre>

<h3 id="回退到历史版本">回退到历史版本</h3>

<p>现在，我们可以决定回退当前的rollout到之前的版本：</p>

<pre><code class="language-shell">$ kubectl rollout undo deployment/nginx-deployment
deployment &quot;nginx-deployment&quot; rolled back
</code></pre>

<p>也可以使用 <code>--revision</code>参数指定某个历史版本：</p>

<pre><code class="language-shell">$ kubectl rollout undo deployment/nginx-deployment --to-revision=2
deployment &quot;nginx-deployment&quot; rolled back
</code></pre>

<p>与rollout相关的命令详细文档见<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/user-guide/kubectl/v1.6/#rollout">kubectl rollout</a>。</p>

<p>该Deployment现在已经回退到了先前的稳定版本。如你所见，Deployment controller产生了一个回退到revison 2的<code>DeploymentRollback</code>的event。</p>

<pre><code class="language-shell">$ kubectl get deployment
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3         3         3            3           30m

$ kubectl describe deployment
Name:           nginx-deployment
Namespace:      default
CreationTimestamp:  Tue, 15 Mar 2016 14:48:04 -0700
Labels:         app=nginx
Selector:       app=nginx
Replicas:       3 updated | 3 total | 3 available | 0 unavailable
StrategyType:       RollingUpdate
MinReadySeconds:    0
RollingUpdateStrategy:  1 max unavailable, 1 max surge
OldReplicaSets:     &lt;none&gt;
NewReplicaSet:      nginx-deployment-1564180365 (3/3 replicas created)
Events:
  FirstSeen LastSeen    Count   From                    SubobjectPath   Type        Reason              Message
  --------- --------    -----   ----                    -------------   --------    ------              -------
  30m       30m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-2035384211 to 3
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 1
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 2
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 2
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 0
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 2
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 1
  29m       29m         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-1564180365 to 2
  2m        2m          1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-3066724191 to 0
  2m        2m          1       {deployment-controller }                Normal      DeploymentRollback  Rolled back deployment &quot;nginx-deployment&quot; to revision 2
  29m       2m          2       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 3
</code></pre>

<h3 id="清理policy">清理Policy</h3>

<p>你可以通过设置<code>.spec.revisonHistoryLimit</code>项来指定deployment最多保留多少revison历史记录。默认的会保留所有的revision；如果将该项设置为0，Deployment就不允许回退了。</p>

<h2 id="deployment扩容">Deployment扩容</h2>

<p>你可以使用以下命令扩容Deployment：</p>

<pre><code class="language-shell">$ kubectl scale deployment nginx-deployment --replicas 10
deployment &quot;nginx-deployment&quot; scaled
</code></pre>

<p>假设你的集群中启用了<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough">horizontal pod autoscaling</a>，你可以给Deployment设置一个autoscaler，基于当前Pod的CPU利用率选择最少和最多的Pod数。</p>

<pre><code class="language-shell">$ kubectl autoscale deployment nginx-deployment --min=10 --max=15 --cpu-percent=80
deployment &quot;nginx-deployment&quot; autoscaled
</code></pre>

<h2 id="比例扩容">比例扩容</h2>

<p>RollingUpdate Deployment支持同时运行一个应用的多个版本。当你活着autoscaler扩容RollingUpdate Deployment的时候，正在中途的rollout（进行中或者已经暂停的），为了降低风险，Deployment controller将会平衡已存在的活动中的ReplicaSets（有Pod的ReplicaSets）和新加入的replicas。这被称为比例扩容。</p>

<p>例如，你正在运行中含有10个replica的Deployment。maxSurge=3，maxUnavailable=2。</p>

<pre><code class="language-shell">$ kubectl get deploy
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment     10        10        10           10          50s
</code></pre>

<p>你更新了一个镜像，而在集群内部无法解析。</p>

<pre><code class="language-shell">$ kubectl set image deploy/nginx-deployment nginx=nginx:sometag
deployment &quot;nginx-deployment&quot; image updated
</code></pre>

<p>镜像更新启动了一个包含ReplicaSet nginx-deployment-1989198191的新的rollout，但是它被阻塞了，因为我们上面提到的maxUnavailable。</p>

<pre><code class="language-shell">$ kubectl get rs
NAME                          DESIRED   CURRENT   READY     AGE
nginx-deployment-1989198191   5         5         0         9s
nginx-deployment-618515232    8         8         8         1m
</code></pre>

<p>然后发起了一个新的Deployment扩容请求。autoscaler将Deployment的repllica数目增加到了15个。Deployment controller需要判断在哪里增加这5个新的replica。如果我们没有谁用比例扩容，所有的5个replica都会加到一个新的ReplicaSet中。如果使用比例扩容，新添加的replica将传播到所有的ReplicaSet中。大的部分加入replica数最多的ReplicaSet中，小的部分加入到replica数少的ReplciaSet中。0个replica的ReplicaSet不会被扩容。</p>

<p>在我们上面的例子中，3个replica将添加到旧的ReplicaSet中，2个replica将添加到新的ReplicaSet中。rollout进程最终会将所有的replica移动到新的ReplicaSet中，假设新的replica成为健康状态。</p>

<pre><code class="language-shell">$ kubectl get deploy
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment     15        18        7            8           7m
$ kubectl get rs
NAME                          DESIRED   CURRENT   READY     AGE
nginx-deployment-1989198191   7         7         0         7m
nginx-deployment-618515232    11        11        11        7m
</code></pre>

<h2 id="暂停和恢复deployment">暂停和恢复Deployment</h2>

<p>你可以在出发一次或多次更新前暂停一个Deployment，然后再恢复它。这样你就能多次暂停和恢复Deployment，在此期间进行一些修复工作，而不会出发不必要的rollout。</p>

<p>例如使用刚刚创建Deployment：</p>

<pre><code class="language-shell">$ kubectl get deploy
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
nginx     3         3         3            3           1m
[mkargaki@dhcp129-211 kubernetes]$ kubectl get rs
NAME               DESIRED   CURRENT   READY     AGE
nginx-2142116321   3         3         3         1m
</code></pre>

<p>使用以下命令暂停Deployment：</p>

<pre><code class="language-shell">$ kubectl rollout pause deployment/nginx-deployment
deployment &quot;nginx-deployment&quot; paused
</code></pre>

<p>然后更新Deplyment中的镜像：</p>

<pre><code class="language-shell">$ kubectl set image deploy/nginx nginx=nginx:1.9.1
deployment &quot;nginx-deployment&quot; image updated
</code></pre>

<p>注意新的rollout启动了：</p>

<pre><code class="language-shell">$ kubectl rollout history deploy/nginx
deployments &quot;nginx&quot;
REVISION  CHANGE-CAUSE
1   &lt;none&gt;

$ kubectl get rs
NAME               DESIRED   CURRENT   READY     AGE
nginx-2142116321   3         3         3         2m
</code></pre>

<p>你可以进行任意多次更新，例如更新使用的资源：</p>

<pre><code class="language-shell">$ kubectl set resources deployment nginx -c=nginx --limits=cpu=200m,memory=512Mi
deployment &quot;nginx&quot; resource requirements updated
</code></pre>

<p>Deployment暂停前的初始状态将继续它的功能，而不会对Deployment的更新产生任何影响，只要Deployment是暂停的。</p>

<p>最后，恢复这个Deployment，观察完成更新的ReplicaSet已经创建出来了：</p>

<pre><code class="language-shell">$ kubectl rollout resume deploy nginx
deployment &quot;nginx&quot; resumed
$ KUBECTL get rs -w
NAME               DESIRED   CURRENT   READY     AGE
nginx-2142116321   2         2         2         2m
nginx-3926361531   2         2         0         6s
nginx-3926361531   2         2         1         18s
nginx-2142116321   1         2         2         2m
nginx-2142116321   1         2         2         2m
nginx-3926361531   3         2         1         18s
nginx-3926361531   3         2         1         18s
nginx-2142116321   1         1         1         2m
nginx-3926361531   3         3         1         18s
nginx-3926361531   3         3         2         19s
nginx-2142116321   0         1         1         2m
nginx-2142116321   0         1         1         2m
nginx-2142116321   0         0         0         2m
nginx-3926361531   3         3         3         20s
^C
$ KUBECTL get rs
NAME               DESIRED   CURRENT   READY     AGE
nginx-2142116321   0         0         0         2m
nginx-3926361531   3         3         3         28s
</code></pre>

<p><strong>注意：</strong>在恢复Deployment之前你无法回退一个暂停了个Deployment。</p>

<h2 id="deployment状态">Deployment状态</h2>

<p>Deployment在生命周期中有多种状态。在创建一个新的ReplicaSet的时候它可以是 <a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md#progressing-deployment">progressing</a> 状态， <a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md#complete-deployment">complete</a> 状态，或者<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md#failed-deployment">fail to progress</a>状态。</p>

<h3 id="progressing-deployment">Progressing Deployment</h3>

<p>Kubernetes将执行过下列任务之一的Deployment标记为*progressing*状态：</p>

<ul>
<li>Deployment正在创建新的ReplicaSet过程中。</li>
<li>Deployment正在扩容一个已有的ReplicaSet。</li>
<li>Deployment正在缩容一个已有的ReplicaSet。</li>
<li>有新的可用的pod出现。</li>
</ul>

<p>你可以使用<code>kubectl roullout status</code>命令监控Deployment的进度。</p>

<h3 id="complete-deployment">Complete Deployment</h3>

<p>Kubernetes将包括以下特性的Deployment标记为*complete*状态：</p>

<ul>
<li>Deployment最小可用。最小可用意味着Deployment的可用replica个数等于或者超过Deployment策略中的期望个数。</li>
<li>所有与该Deployment相关的replica都被更新到了你指定版本，也就说更新完成。</li>
<li>该Deployment中没有旧的Pod存在。</li>
</ul>

<p>你可以用<code>kubectl rollout status</code>命令查看Deployment是否完成。如果rollout成功完成，<code>kubectl rollout status</code>将返回一个0值的Exit Code。</p>

<pre><code class="language-bash">$ kubectl rollout status deploy/nginx
Waiting for rollout to finish: 2 of 3 updated replicas are available...
deployment &quot;nginx&quot; successfully rolled out
$ echo $?
0
</code></pre>

<h3 id="failed-deployment">Failed Deployment</h3>

<p>你的Deployment在尝试部署新的ReplicaSet的时候可能卡住，用于也不会完成。这可能是因为以下几个因素引起的：</p>

<ul>
<li>无效的引用</li>
<li>不可读的probe failure</li>
<li>镜像拉取错误</li>
<li>权限不够</li>
<li>范围限制</li>
<li>程序运行时配置错误</li>
</ul>

<p>探测这种情况的一种方式是，在你的Deployment spec中指定<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md#progress-deadline-seconds"><code>spec.progressDeadlineSeconds</code></a>。<code>spec.progressDeadlineSeconds</code> 表示Deployment controller等待多少秒才能确定（通过Deployment status）Deployment进程是卡住的。</p>

<p>下面的<code>kubectl</code>命令设置<code>progressDeadlineSeconds</code> 使controller在Deployment在进度卡住10分钟后报告：</p>

<pre><code class="language-bash">$ kubectl patch deployment/nginx-deployment -p '{&quot;spec&quot;:{&quot;progressDeadlineSeconds&quot;:600}}'
&quot;nginx-deployment&quot; patched
</code></pre>

<p>Once the deadline has been exceeded, the Deployment controller adds a  with the following attributes to the Deployment&rsquo;s</p>

<p>当超过截止时间后，Deployment controller会在Deployment的 <code>status.conditions</code>中增加一条DeploymentCondition，它包括如下属性：</p>

<ul>
<li>Type=Progressing</li>
<li>Status=False</li>
<li>Reason=ProgressDeadlineExceeded</li>
</ul>

<p>浏览 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/api-conventions.md#typical-status-properties">Kubernetes API conventions</a> 查看关于status conditions的更多信息。</p>

<p><strong>注意：</strong>kubernetes除了报告<code>Reason=ProgressDeadlineExceeded</code>状态信息外不会对卡住的Deployment做任何操作。更高层次的协调器可以利用它并采取相应行动，例如，回滚Deployment到之前的版本。</p>

<p><strong>注意：</strong>如果你暂停了一个Deployment，在暂停的这段时间内kubernetnes不会检查你指定的deadline。你可以在Deployment的rollout途中安全的暂停它，然后再恢复它，这不会触发超过deadline的状态。</p>

<p>你可能在使用Deployment的时候遇到一些短暂的错误，这些可能是由于你设置了太短的timeout，也有可能是因为各种其他错误导致的短暂错误。例如，假设你使用了无效的引用。当你Describe Deployment的时候可能会注意到如下信息：</p>

<pre><code class="language-bash">$ kubectl describe deployment nginx-deployment
&lt;...&gt;
Conditions:
  Type            Status  Reason
  ----            ------  ------
  Available       True    MinimumReplicasAvailable
  Progressing     True    ReplicaSetUpdated
  ReplicaFailure  True    FailedCreate
&lt;...&gt;
</code></pre>

<p>执行 <code>kubectl get deployment nginx-deployment -o yaml</code>，Deployement 的状态可能看起来像这个样子：</p>

<pre><code class="language-yaml">status:
  availableReplicas: 2
  conditions:
  - lastTransitionTime: 2016-10-04T12:25:39Z
    lastUpdateTime: 2016-10-04T12:25:39Z
    message: Replica set &quot;nginx-deployment-4262182780&quot; is progressing.
    reason: ReplicaSetUpdated
    status: &quot;True&quot;
    type: Progressing
  - lastTransitionTime: 2016-10-04T12:25:42Z
    lastUpdateTime: 2016-10-04T12:25:42Z
    message: Deployment has minimum availability.
    reason: MinimumReplicasAvailable
    status: &quot;True&quot;
    type: Available
  - lastTransitionTime: 2016-10-04T12:25:39Z
    lastUpdateTime: 2016-10-04T12:25:39Z
    message: 'Error creating: pods &quot;nginx-deployment-4262182780-&quot; is forbidden: exceeded quota:
      object-counts, requested: pods=1, used: pods=3, limited: pods=2'
    reason: FailedCreate
    status: &quot;True&quot;
    type: ReplicaFailure
  observedGeneration: 3
  replicas: 2
  unavailableReplicas: 2
</code></pre>

<p>最终，一旦超过Deployment进程的deadline，kuberentes会更新状态和导致Progressing状态的原因：</p>

<pre><code class="language-Bash">Conditions:
  Type            Status  Reason
  ----            ------  ------
  Available       True    MinimumReplicasAvailable
  Progressing     False   ProgressDeadlineExceeded
  ReplicaFailure  True    FailedCreate
</code></pre>

<p>你可以通过缩容Deployment的方式解决配额不足的问题，或者增加你的namespace的配额。如果你满足了配额条件后，Deployment controller就会完成你的Deployment rollout，你将看到Deployment的状态更新为成功状态（<code>Status=True</code>并且<code>Reason=NewReplicaSetAvailable</code>）。</p>

<pre><code class="language-bash">Conditions:
  Type          Status  Reason
  ----          ------  ------
  Available     True    MinimumReplicasAvailable
  Progressing   True    NewReplicaSetAvailable
</code></pre>

<p><code>Type=Available</code>、 <code>Status=True</code> 以为这你的Deployment有最小可用性。 最小可用性是在Deployment策略中指定的参数。<code>Type=Progressing</code> 、 <code>Status=True</code>意味着你的Deployment 或者在部署过程中，或者已经成功部署，达到了期望的最少的可用replica数量（查看特定状态的Reason——在我们的例子中<code>Reason=NewReplicaSetAvailable</code> 意味着Deployment已经完成）。</p>

<p>你可以使用<code>kubectl rollout status</code>命令查看Deployment进程是否失败。当Deployment过程超过了deadline，<code>kubectl rollout status</code>将返回非0的exit code。</p>

<pre><code class="language-bash">$ kubectl rollout status deploy/nginx
Waiting for rollout to finish: 2 out of 3 new replicas have been updated...
error: deployment &quot;nginx&quot; exceeded its progress deadline
$ echo $?
1
</code></pre>

<h3 id="操作失败的deployment">操作失败的Deployment</h3>

<p>所有对完成的Deployment的操作都适用于失败的Deployment。你可以对它阔／缩容，回退到历史版本，你甚至可以多次暂停它来应用Deployment pod template。</p>

<h2 id="清理policy-1">清理Policy</h2>

<p>你可以设置Deployment中的 <code>.spec.revisionHistoryLimit</code> 项来指定保留多少旧的ReplicaSet。 余下的将在后台被当作垃圾收集。默认的，所有的revision历史就都会被保留。在未来的版本中，将会更改为2。</p>

<p><strong>注意：</strong>将该值设置为0，将导致所有的Deployment历史记录都会被清除，该Deploynent就无法再回退了。</p>

<h2 id="用例">用例</h2>

<h3 id="金丝雀deployment">金丝雀Deployment</h3>

<p>如果你想要使用Deployment对部分用户或服务器发布relaese，你可以创建多个Deployment，每个对一个release，参照<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/cluster-administration/manage-deployment/#canary-deployments">managing resources</a> 中对金丝雀模式的描述。</p>

<h2 id="编写deployment-spec">编写Deployment Spec</h2>

<p>在所有的Kubernetes配置中，Deployment也需要<code>apiVersion</code>，<code>kind</code>和<code>metadata</code>这些配置项。配置文件的通用使用说明查看<a href="https://kubernetes.io/docs/tutorials/stateless-application/run-stateless-application-deployment">部署应用</a>，配置容器，和<a href="https://kubernetes.io/docs/tutorials/object-management-kubectl/object-management">使用kubeclt管理资源</a>文档。</p>

<p>Deployment也需要 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/api-conventions.md#spec-and-status"><code>.spec</code> section</a>.</p>

<h3 id="pod-template">Pod Template</h3>

<p><code>.spec.template</code> 是 <code>.spec</code>中唯一要求的字段。</p>

<p><code>.spec.template</code> 是 <a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/user-guide/replication-controller/#pod-template">pod template</a>. 它跟 <a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/user-guide/pods">Pod</a>有一模一样的schema，除了它是嵌套的并且不需要<code>apiVersion</code> 和 <code>kind</code>字段。</p>

<p>另外为了划分Pod的范围，Deployment中的pod template必须指定适当的label（不要跟其他controller重复了，参考<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md#selector">selector</a>）和适当的重启策略。</p>

<p><a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/pods/pod-lifecycle"><code>.spec.template.spec.restartPolicy</code></a> 可以设置为 <code>Always</code> , 如果不指定的话这就是默认配置。</p>

<h3 id="replicas">Replicas</h3>

<p><code>.spec.replicas</code> 是可以选字段，指定期望的pod数量，默认是1。</p>

<h3 id="selector">Selector</h3>

<p><code>.spec.selector</code>是可选字段，用来指定 <a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/overview/working-with-objects/labels">label selector</a> ，圈定Deployment管理的pod范围。</p>

<p>如果被指定， <code>.spec.selector</code> 必须匹配 <code>.spec.template.metadata.labels</code>，否则它将被API拒绝。如果 <code>.spec.selector</code> 没有被指定， <code>.spec.selector.matchLabels</code> 默认是 <code>.spec.template.metadata.labels</code>。</p>

<p>在Pod的template跟<code>.spec.template</code>不同或者数量超过了<code>.spec.replicas</code>规定的数量的情况下，Deployment会杀掉label跟selector不同的Pod。</p>

<p><strong>注意：</strong>你不应该再创建其他label跟这个selector匹配的pod，或者通过其他Deployment，或者通过其他Controller，例如ReplicaSet和ReplicationController。否则该Deployment会被把它们当成都是自己创建的。Kubernetes不会阻止你这么做。</p>

<p>如果你有多个controller使用了重复的selector，controller们就会互相打架并导致不正确的行为。</p>

<h3 id="策略">策略</h3>

<p><code>.spec.strategy</code> 指定新的Pod替换旧的Pod的策略。 <code>.spec.strategy.type</code> 可以是&rdquo;Recreate&rdquo;或者是 &ldquo;RollingUpdate&rdquo;。&rdquo;RollingUpdate&rdquo;是默认值。</p>

<h4 id="recreate-deployment">Recreate Deployment</h4>

<p><code>.spec.strategy.type==Recreate</code>时，在创建出新的Pod之前会先杀掉所有已存在的Pod。</p>

<h4 id="rolling-update-deployment">Rolling Update Deployment</h4>

<p><code>.spec.strategy.type==RollingUpdate</code>时，Deployment使用<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/tasks/run-application/rolling-update-replication-controller">rolling update</a> 的方式更新Pod 。你可以指定<code>maxUnavailable</code> 和 <code>maxSurge</code> 来控制 rolling update 进程。</p>

<h5 id="max-unavailable">Max Unavailable</h5>

<p><code>.spec.strategy.rollingUpdate.maxUnavailable</code> 是可选配置项，用来指定在升级过程中不可用Pod的最大数量。该值可以是一个绝对值（例如5），也可以是期望Pod数量的百分比（例如10%）。通过计算百分比的绝对值向下取整。如果<code>.spec.strategy.rollingUpdate.maxSurge</code> 为0时，这个值不可以为0。默认值是1。</p>

<p>例如，该值设置成30%，启动rolling update后旧的ReplicatSet将会立即缩容到期望的Pod数量的70%。新的Pod ready后，随着新的ReplicaSet的扩容，旧的ReplicaSet会进一步缩容，确保在升级的所有时刻可以用的Pod数量至少是期望Pod数量的70%。</p>

<h5 id="max-surge">Max Surge</h5>

<p><code>.spec.strategy.rollingUpdate.maxSurge</code> 是可选配置项，用来指定可以超过期望的Pod数量的最大个数。该值可以是一个绝对值（例如5）或者是期望的Pod数量的百分比（例如10%）。当<code>MaxUnavailable</code>为0时该值不可以为0。通过百分比计算的绝对值向上取整。默认值是1。</p>

<p>例如，该值设置成30%，启动rolling update后新的ReplicatSet将会立即扩容，新老Pod的总数不能超过期望的Pod数量的130%。旧的Pod被杀掉后，新的ReplicaSet将继续扩容，旧的ReplicaSet会进一步缩容，确保在升级的所有时刻所有的Pod数量和不会超过期望Pod数量的130%。</p>

<h3 id="progress-deadline-seconds">Progress Deadline Seconds</h3>

<p><code>.spec.progressDeadlineSeconds</code> 是可选配置项，用来指定在系统报告Deployment的<a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/controllers/deployment.md#failed-deployment">failed progressing</a> ——表现为resource的状态中<code>type=Progressing</code>、<code>Status=False</code>、 <code>Reason=ProgressDeadlineExceeded</code>前可以等待的Deployment进行的秒数。Deployment controller会继续重试该Deployment。未来，在实现了自动回滚后， deployment controller在观察到这种状态时就会自动回滚。</p>

<p>如果设置该参数，该值必须大于 <code>.spec.minReadySeconds</code>。</p>

<h3 id="min-ready-seconds">Min Ready Seconds</h3>

<p><code>.spec.minReadySeconds</code>是一个可选配置项，用来指定没有任何容器crash的Pod并被认为是可用状态的最小秒数。默认是0（Pod在ready后就会被认为是可用状态）。进一步了解什么什么后Pod会被认为是ready状态，参阅 <a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/concepts/workloads/pods/pod-lifecycle/#container-probes">Container Probes</a>。</p>

<h3 id="rollback-to">Rollback To</h3>

<p><code>.spec.rollbackTo</code> 是一个可以选配置项，用来配置Deployment回退的配置。设置该参数将触发回退操作，每次回退完成后，该值就会被清除。</p>

<h4 id="revision">Revision</h4>

<p><code>.spec.rollbackTo.revision</code>是一个可选配置项，用来指定回退到的revision。默认是0，意味着回退到历史中最老的revision。</p>

<h3 id="revision-history-limit">Revision History Limit</h3>

<p>Deployment revision history存储在它控制的ReplicaSets中。</p>

<p><code>.spec.revisionHistoryLimit</code> 是一个可选配置项，用来指定可以保留的旧的ReplicaSet数量。该理想值取决于心Deployment的频率和稳定性。如果该值没有设置的话，默认所有旧的Replicaset或会被保留，将资源存储在etcd中，是用<code>kubectl get rs</code>查看输出。每个Deployment的该配置都保存在ReplicaSet中，然而，一旦你删除的旧的RepelicaSet，你的Deployment就无法再回退到那个revison了。</p>

<p>如果你将该值设置为0，所有具有0个replica的ReplicaSet都会被删除。在这种情况下，新的Deployment rollout无法撤销，因为revision history都被清理掉了。</p>

<h3 id="paused">Paused</h3>

<p><code>.spec.paused</code>是可以可选配置项，boolean值。用来指定暂停和恢复Deployment。Paused和没有paused的Deployment之间的唯一区别就是，所有对paused deployment中的PodTemplateSpec的修改都不会触发新的rollout。Deployment被创建之后默认是非paused。</p>

<h2 id="alternative-to-deployments">Alternative to Deployments</h2>

<h3 id="kubectl-rolling-update">kubectl rolling update</h3>

<p><a href="https://github.com/kubernetes/kubernetes.github.io/blob/master/docs/user-guide/kubectl/v1.6/#rolling-update">Kubectl rolling update</a> 虽然使用类似的方式更新Pod和ReplicationController。但是我们推荐使用Deployment，因为它是声明式的，客户端侧，具有附加特性，例如及时滚动升级结束后也可以回滚到任何历史版本。</p>

            </article>

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://jimmysong.io/posts/kubernetes-service-rolling-update/" data-toggle="tooltip" data-placement="top" title="Kubernetes中的Rolling Update服务滚动升级">&larr; Previous Post</a>
                </li>
                 
                <li class="next">
                    <a href="https://jimmysong.io/posts/kubernetes-logstash/" data-toggle="tooltip" data-placement="top" title="使用Logstash收集Kubernetes的应用日志">Next Post &rarr;</a>
                </li>
                
            </ul>
            
            <div>
                 
                <h2>See Also</h2>
                <ul>
                    
                    <li><a href="/posts/kubernetes-service-rolling-update/">Kubernetes中的Rolling Update服务滚动升级</a></li>
                    
                    <li><a href="/posts/kubernetes-edge-node-configuration/">使用traefik和keepalived配置kubernetes的边缘节点</a></li>
                    
                    <li><a href="/posts/kubernetes-with-glusterfs/">在kubernetes中使用glusterfs做持久化存储</a></li>
                    
                    <li><a href="/posts/kubernetes-performance-test/">Kubernetes网络和集群性能测试</a></li>
                    
                    <li><a href="/posts/distributed-load-testing-using-kubernetes/">运用kubernetes进行分布式负载测试</a></li>
                    
                </ul>
                
            </div>
            
            
            
            
<div>
    <section id="datecount">
        <h4 id="date"> Sat May 13, 2017</h4>
    </section>
    <h5 id="wc">12500 Words|Read in about 25 Min</h5>
    <h5 id="tags">Tags: 
        
        <a href="https://jimmysong.io/tags/kubernetes/">kubernetes</a> &nbsp;
    </h5>
</div>

            
            </div>
            
            
        </div>
    </div>
    </section>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
        <img src="https://ws1.sinaimg.cn/large/00704eQkly1fs0lebokxaj30a004gq44.jpg">
          
              <li>
                <a href="mailto:jimmysong@jimmysong.io" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/jimmysongio" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rootsongjc" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/jimmysongio" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/jimmysongio" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://jimmysong.io/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017-2018
          
            
              <a href="https://jimmysong.io">Jimmy Song(宋净超)</a>
            
          
          
          
            &nbsp;&bull;&nbsp;
            <a href="https://jimmysong.io/">Jimmy Song</a>
          
        </p>
        <p class="credits theme-by text-muted">
        <a href="https://servicemesher.github.io">ServiceMesher</a>&nbsp;&bull;&nbsp;<a href="https://dataikudss.com">dataikudss.com</a>&nbsp;&bull;&nbsp;<a href="https://cloudnativego.com">cloudnativego.com</a>
        </p>

        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.40</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/rootsongjc/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>


<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/bootstrap.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe-ui-default.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/auto-render.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/main.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/prism.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/katex.min.js"></script>
<script> renderMathInElement(document.body); </script>







  </body>
</html>

